---
title: "インフラエンジニアを目指すならこれをやるといいんじゃない？"
emoji: "🍣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [ansible, infra]
published: false
---

## はじめに

インフラ周りのタスクをやり始めて3ヶ月くらい立ったので、これ知っておいて良かったなとか教わって良かったなというものをまとめてみました。
インフラも気になるなと思っている方の参考になれば幸いです。

とはいえ自分の主観をつらつら書いているので、こうした方がいいよ！という意見があればぜひ教えていただきたいです。

## CLIの設定

shellは特にこだわりがないのであれば多機能で情報も豊富なzshがオススメです。
CIやサーバー環境でよく使用されているbashとも似ているというメリットもあります。

## CLIツール

CLI生活を豊かにするためには操作対象の選択やディレクトリ移動は爆速で行う必要があります。
対象の選択はファジーファインダー、ディレクトリ移動には`zコマンド`を使いましょう。

### ファジーファインダー

ファジーファインダーとは、入力した文字列に対して部分一致で検索を行う機能です。
ファイルの指定やhistoryの検索などで便利です。

@[card](https://github.com/junegunn/fzf)

### zコマンド

## サーバーの接続情報管理 ~/.ssh/config

案件を掛け持ちしている関係で、環境変数やらssh接続先の情報やらの管理が煩雑です。
ホスト名とか使用している鍵とかとにかく覚えられない、というかもう覚えてない。

そんなあなたにお勧めしたいのが`~/.ssh/config`です。

通常の方法でssh接続するときには以下のようなコマンドを入力します。

```sh
ssh -i ~/.ssh/秘密鍵 -p 22 user@hostname
```

毎回これを打つのは面倒です。そこで`~/.ssh/config`の出番です。
フォーマットは以下の通りです。

```config
HOST エイリアス
  HOSTNAME 接続先のIPアドレス
  User 接続するユーザー名
  Port 22
  IdentityFile 秘密鍵のパス(例: ~/.ssh/hoge_key)
```

例えば以下のように設定すると、`ssh HOSTの文字列`で接続することができます。

```config: ~/.ssh/config
HOST __hoge_prod
  HOSTNAME 192.168.64.7
  User ec2-user
  Port 22
  IdentityFile ~/.ssh/id_ed25519
```

```sh
ssh __hoge_prod
```

どのホストがどの鍵で接続できるのか、対応するユーザー名はどれかを覚えていなくてもエイリアス指定で接続できるため楽です。

### ~/.ssh/configを分割して管理する

接続先の数が増えていくと一つのファイルで管理するのが辛くなります。
そのため、案件やプロダクトごとにファイルを分割して管理するといいです。
以下のようにファイルを分割するとします。

この場合、`~/.ssh/config.d/hosts`ディレクトリを作成して、その中にホストごとのファイルを作成します。
~/.ssh/configには以下のように記述します。

```config
Include conf.d/hosts/*
```

## AWS profileの管理

AWSのリソースをCLIやIaCで操作する場合、AWS profileを使うことが多いです。
誤って別のAWS profileを使ってしまってterraform applyしちゃった！なんて悲劇を起こさないためにも、AWS profileの管理は重要です。

上記のような悲劇を防ぐ方法として自分は以下のようにしています。

- aws profileのdefaultは使わない
- terraformを実行する前に `aws configure list` で使うprofileを確認する

### セキュリティへの理解

AWSのリソースを操作するにあたり、権限エラーが発生することがあります。
どの権限が必要なのか？どのポリシーで引っかかっているのか？を理解して必要な権限を先方に依頼する必要があります。

AWSの権限は以下のようなものがあります。

- IAMユーザー
  たくさんあって大変ですが、最初は全体像を把握して都度公式ドキュメントを確認するといいと思います。

## VMの用意

VMを用意する方法としてよくみるのは以下の2つです。

- Vagrant + VirtualBox (Apple Siliconでは使えない)
- multipass

VirtualBoxは最新バージョンでApple Siliconに対応したものの、Vagrantは最新のVirtualBoxに対応していないため、Apple SiliconでのVM構築は難しいです。
multipassでは、Ubuntuのみにはなりますが、Apple SiliconでもVMを構築することができます。

## IaCとかいうもの

何となくでTerraformを触っていたのですが、まさかの実務で使う時がきました。正確には自分で使うことを提案して使うことになりました。
人生何があるかわからないので、色々触っておくもんですね。

自分は以下の場面で使うことがありました。

- Apple SiliconでのVM構築に制限がある
- 働いている時だけサーバーを立てて検証したい

サーバーの負荷検証については、それなりのスペックのサーバーを立てるため、費用がかかります。
サーバー費用を抑えるためにも、IaCで構築したサーバーを使い捨てることができるので便利です。
あとは自分が万が一何かやらかしたとしても、IaCで構築したサーバーを削除して再度用意することができます。
検証への心理的ハードルを下げる意味でも、IaCは便利です。あと、単純に環境の設定がコード化されているのは何だか気持ちがいいものです。

作成したサーバーのスペックなんだっけ？ってなった時にも、GUI上でポチポチせずともコードで一覧として確認することができるため復習もしやすいです。

### TerraformとAnsible

IaCといえばTerraform, CDK, Ansibleなど色々あります。

Terraformはクラウドのリソースを管理し、アプリケーションの管理をAnsibleで行なっています。
どこまでをどちらで管理するか？は状況によって変わると思いますが、自分は以下のように使っています。

DBの用意→Terraform
設定ファイルやその他のツールの導入

DBの用意そのものはあまり変更することが無いため、Terraformで管理しています。
設定ファイルは変更することが多いため、Ansibleで管理しています。

Terraformの嬉しみ/つらみ

- クラウドの構成管理ができる
- user_dataでエラーがあったのかどうかがわかりにくい

Ansibleの嬉しみ/つらみ

- ステップごとでログが出るためデバッグしやすい
- クラウドのリソースの管理ができない

## インフラの勉強について

インフラって何から勉強したらいいの！？ってなりますよね。自分もその一人でした。
Linuxの勉強を始めたものの、コマンドが全て呪文に見えました。オプションもミリも覚えられませんでした。
VMのファイルシステムを壊したこともあります。才能がないのかもしれない。

完全に個人の意見ですが、自分なら以下の順番が楽しいんじゃないかなと思います。
勉強のモチベがな〜って人向けです。インフラは手を動かして学ぶのが頭に入りやすいです。

1. 基本情報やLPICの本をさらっと読む

いきなり「座学で資格勉強！」は辛いものです。まずはどんなものがあるかを知るくらいでいいと思います。
大切なことは、自分が何を知らないのかを知っておくことです。
課題に直面した時にどの情報を参照すればいいかがわかるようになります。

そもそもCLIの画面が怖い、うっかり壊しちゃいそうと不安になる方は以下の書籍がオススメです。

- [1週間でLPICの基礎が学べる本 第3版 (1週間シリーズ)](https://amzn.asia/d/7N67HUa)
- [Linux教科書 LPICレベル1 Version5.0対応](https://amzn.asia/d/5XlIceF)

## Vim

カスタマイズが面白すぎて沼なのでお勧めしたい気持ちとやめた方がいいじゃないかという葛藤があります。
とはいえ自分はやって良かったなと思っているので共有します。
サーバー内で一時的に設定ファイルを書き換えて動作検証を行うことがあるのでvimの基本操作を知っておくと便利です。

Vimの操作を覚えるためにやったことは以下の通りです。

- vimtutorをやる
  vimtutorって打てばできます。実際に操作しながらできるのでおすすめです。
- youtubeでVimの動画を見る
  どのキーバインドから覚えていくか悩むと思うのでこの動画から覚えていくといいと思います。

@[card](https://youtu.be/UP0oV_1Q0Q8?si=XvjPim24D2uHaDWj)

基本的な操作が網羅されており、動画をみながら真似をしたら慣れました。

vimのカスタマイズをするとエディタそのものに詳しくなるため、エディタの機能をフル活用してコーディングを快適にすることができるようになります。
リンターを設定しておけば、間違って指定している値なんかに気づくことができます。
LSPを設定しておけば補完候補でどんな機能があるかを教えてくれます。

知らないことはエディタが助けてくれます。

## トラブルシューティングで使うコマンド

初めのうちはとにかくトラブル続きでトラブルシューティングを行う機会が多くあります。

以下のようなコマンドを覚えておくと原因を特定するのに役立ちます。

### ログはlessで見る

インフラに限らず、ログの確認を行うことがあります。
誰に調査を依頼するか？を考える時に何に問題があるかを切り分けを行います。
その際に参照する情報の一つとしてログの確認があります。

ログファイルは膨大な行数に及ぶことがあるため、catでみると一気に表示されてしまい、辛くなります。
そういう時はlessコマンドでログを表示しましょう。

### サーバーに接続できない時はまずはポートが空いているか確認

## おまけ: 心構えとか

4ヶ月目の人間の心構えって何やねん、と思われるかもしれませんがおいておきます。誇り高く生きるために。
当たり前っちゃ当たり前なのかもしれませんが、実は難しいんですよね。
ちょっとずつ当たり前のレベルを上げていくことを意識しています。

- 作業ログを残す！！
  環境構築の手順って以外とめんどくさかったりします。何なら1ヶ月前にやったことを2、3回ことやることもあったりします。一度きりとは思わず雑でもいいので実行したコマンドをや試したことをメモしておきましょう。
  後になって振り返ってみると、この作業は不要だったな、このコマンドは最初に実行して問題を切り分けるべきだったな などなど気づくことが出てくるかもしれません。

- 反省会は短く！コンスタントに！
  PDCAサイクルを回して下さい。人間誰しも間違いを繰り返すしびっくりするほど忘れます。大切なのは繰り返さないこと、忘れたとしても思い出せること。
  ここで立てるPlanは同じような失敗を起こさないための対策です。気をつけるではなく仕組みで解決するように習慣づけましょう。

- 一度やったことは繰り返さなくていいように自動化する習慣をつける
  可能な範囲で自動化しましょう。いいアウトプットになります。同じような課題で二重で時間を使うことは避けた方が良いです。
  始めて行う環境構築が出てきたらすかさずIaC管理できないかチャレンジしてみましょう。手動実行とコード化を並行して行うことで理解が深まります。

例：
直近でのやらかしといえば、サーバのディストリビューションを確認しないままAnsibleを書き始めたことでしょうか。
実はひとえにLinuxとはいえど、コマンドやサービス名、サービスの設定ファイルに至るまで結構な差異があります。
Ubuntuだと思って作成したAnsibleをCentOS9 Streamで書き直す事態となり、Ansibleを書き直すことになりました。
あとは事前にこの情報を聞いておくリスト何かを用意するといいかもしれません。

## 自分の使用している環境に詳しくなろう

自分の使用している環境に詳しくなることでシェル何かの理解が深まったりします。
GitHubにdotfiles(設定ファイル)を管理しましょう。コミット履歴が未来の自分を助けます。

### 検証環境の用意を爆速で用意できるようにする

Git管理に詳しくは書いているのですが、とにかく検証するスピードを早くするに越したことはありません。やってみて始めてわかることも多くあります。
業務フローはできるだけ明確化して、最適化を繰り返し美しくしましょう。

## Ansible

### テンプレートを用意しておこう

Ansibleの用意は意外と面倒です。
ざっくり以下のような手順になります。

- 全てのplaybookを実行できるラッパーを用意する
- inventory.ymlを用意する
- playbookを用意する
- roleを用意する
- ansible.cfgを用意してroleのパスを通す
- ansible-lintのルールを用意する
- READMEに守るべきルールとansible-lintのルールと一致しないものを明記する

### どこまでの完成度にするかは与えられた工数をみて判断しよう

Ansibleは凝ろうと思えば凝れるし、簡単に使えるようにもできます。
どんな状況でも冪等性を担保しようとすると工数が跳ね上がるため、事前に与えられた工数や期日を確認してどこまでの完成度にするかを決めましょう。
常に完璧を目指したい気持ちはありますが、第一に守るべきは顧客の求めているものを期日内に提供することです。

工数に余裕があるなら自分は以下のチェックリストを全て満たすように作成しています。

### 積極的に分割しよう

## まとめ

ちょっぴり長くなったのでまとめます。
この記事で言いたいのは

- インフラは楽しんで学ぼう！
- ログを残せ！！！
- 作業フローは明確に！美しく！頑張らなくてもいいように最初に頑張ろう！
- IaC最高！
- vimは楽しい！

です。

読んでいただきありがとうございました。

## 参照

~/.ssh/config
<https://qiita.com/passol78/items/2ad123e39efeb1a5286b>
zshの設定
<https://qiita.com/ucan-lab/items/1794940a64882021dcb1>
